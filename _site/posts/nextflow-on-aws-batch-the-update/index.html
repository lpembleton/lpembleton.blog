<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.536">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="LW Pembleton">
<meta name="dcterms.date" content="2024-11-18">
<meta name="description" content="An updated guide to setting up Nextflow on AWS Batch with fusion file storage">

<title>Luke Pembleton - Nextflow on AWS Batch with Fusion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/lpembleton/img/dna-logo.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/iconify-1.0.7/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NQ96R1Y33J"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NQ96R1Y33J', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<meta property="og:title" content="Luke Pembleton - Nextflow on AWS Batch with Fusion">
<meta property="og:description" content="An updated guide to setting up Nextflow on AWS Batch with fusion file storage">
<meta property="og:image" content="https://lpembleton.rbind.io/posts/nextflow-on-aws-batch-the-update/images/jason-leung-IrQwXgk8Q88-unsplash.jpg">
<meta property="og:site_name" content="Luke Pembleton">
<meta name="twitter:title" content="Luke Pembleton - Nextflow on AWS Batch with Fusion">
<meta name="twitter:description" content="An updated guide to setting up Nextflow on AWS Batch with fusion file storage">
<meta name="twitter:image" content="https://lpembleton.rbind.io/posts/nextflow-on-aws-batch-the-update/images/jason-leung-IrQwXgk8Q88-unsplash.jpg">
<meta name="twitter:site" content="@lwpembleton">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/lpembleton/img/dna-logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Luke Pembleton</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">ABOUT</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">BLOG</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../ramblings.html"> 
<span class="menu-text">RAMBLINGS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications/publications.html"> 
<span class="menu-text">PUBLICATIONS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/conferences.html"> 
<span class="menu-text">CONFERENCES</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/vivarium.html"> 
<span class="menu-text">VIVARIUM</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lpembleton"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/lwpembleton"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://genomic.social/@lwpembleton"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/lwpembleton.bsky.social"> 
<span class="menu-text"><iconify-icon inline="" icon="arcticons:bluesky-alt" style="font-size: 28px;"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=r7RmM00AAAAJ&amp;hl=en"> 
<span class="menu-text"><iconify-icon inline="" icon="academicons:google-scholar-square" style="font-size: 24px;"></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://publons.com/researcher/3450394/luke-pembleton/"> 
<span class="menu-text"><iconify-icon inline="" icon="academicons:publons-square" style="font-size: 24px;"></iconify-icon></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/lpembleton"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://lpembleton.github.io/StAMPP/"> 
<span class="menu-text"><i class="fa-solid fa-box-open" aria-label="box-open"></i></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Nextflow on AWS Batch with Fusion</h1>
                  <div>
        <div class="description">
          An updated guide to setting up Nextflow on AWS Batch with fusion file storage
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Nextflow</div>
                <div class="quarto-category">AWS</div>
                <div class="quarto-category">Batch</div>
                <div class="quarto-category">Fusion</div>
                <div class="quarto-category">Wave</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>LW Pembleton </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 18, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#iam-setup" id="toc-iam-setup" class="nav-link active" data-scroll-target="#iam-setup">IAM Setup 👤</a></li>
  <li><a href="#custom-nextflow-ami" id="toc-custom-nextflow-ami" class="nav-link" data-scroll-target="#custom-nextflow-ami">Custom Nextflow AMI 📦</a></li>
  <li><a href="#batch-environment" id="toc-batch-environment" class="nav-link" data-scroll-target="#batch-environment">Batch Environment 🎛️</a></li>
  <li><a href="#nextflow-config-launchpad" id="toc-nextflow-config-launchpad" class="nav-link" data-scroll-target="#nextflow-config-launchpad">Nextflow Config &amp; Launchpad 🚀</a></li>
  <li><a href="#additional-notes" id="toc-additional-notes" class="nav-link" data-scroll-target="#additional-notes">Additional Notes 🗒️</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#fusion-storage" id="toc-fusion-storage" class="nav-link" data-scroll-target="#fusion-storage">Fusion storage 💾</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/jason-leung-IrQwXgk8Q88-unsplash.jpg" class="img-fluid figure-img"></p>
<figcaption><sub>Photo&nbsp;by&nbsp;<a href="https://unsplash.com/@ninjason">Jason&nbsp;Leung</a>&nbsp;on&nbsp;Unsplash</sub></figcaption>
</figure>
</div>
<p>It’s been two years since my <a href="https://lpembleton.rbind.io/posts/nextflow-on-aws-batch/">original post</a> on setting up Nextflow with AWS Batch. While there have been many exciting developments in Nextflow, that old post has held up surprisingly well. But there’s been one big change that drove me to update my setup (and this post): the new <a href="https://seqera.io/blog/breakthrough-performance-and-cost-efficiency-with-the-new-fusion-file-system/">Fusion file storage system</a> developed by Seqera Labs.</p>
<p>In my <a href="https://lpembleton.rbind.io/posts/aws-batch-ebs-autoscale/">previous setups</a>, I used EBS autoscaling for storage in my containerised workflows. It worked well, but EBS is expensive, and AWS recently announced they’d no longer support EBS autoscaling. It still works, but for how long…? A little bit before this Seqera Labs (the people behind Nextflow) released Fusion, a system that lets your containers use S3 as though it’s local storage.</p>
<p>I’m not going to go into the details here of how fusion works, you can check it out on their <a href="https://www.nextflow.io/docs/latest/fusion.html">website</a> but essentially is it allows your containers to use S3 as the file storage system as if it was the local disk. In short, much cheaper storage associated compute costs and no more complex EBS autoscaling setups.</p>
<p><img src="images/99sws0.jpg" class="img-fluid"></p>
<p>To use Fusion, you’ll need to run your containers with Wave 🌊, another fantastic tool from Seqera Labs. Wave essentially adds the fusion layer to your containers, giving them get pseudo direct access to S3 storage as though it’s a local disk. All it takes is a config update and an additional IAM permission.</p>
<p><em>Note:</em> Wave and Fusion, require Nextflow v22.10.0 or later. Update Nextflow if you haven’t already:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> self-update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I thought I would take this opportunity to refresh the whole setup guide, and also include a nice little test pipeline to check fusion is working.</p>
<p>If you have already setup Nextflow on AWS following my original blog post, all you should need to do is:</p>
<ul>
<li><p><strong>Add the new IAM policy permission</strong> (see <a href="#iam-setup">IAM Setup 👤</a>, step 14).</p></li>
<li><p><strong>Recreate your Nextflow AMI</strong> if you were previously using EBS autoscaling.</p></li>
<li><p><strong>Update your Batch compute environment and queues</strong> with the new AMI.</p></li>
<li><p><strong>Update Nextflow</strong> on your EC2 launchpad instance.</p></li>
<li><p><strong>Update your Nextflow config</strong> and run a test (see <a href="#fusion-storage">Fusion storage 💾</a> section).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To be honest though I think its easier to just set it up all again, rather than going through and working out what you need to update, here, there, and everywhere 🎸</p>
</div>
</div></li>
</ul>
<p>So lets get started 🟢</p>
<p>Although Gandalf 🧙 trims his beard more often than Amazon dramatically updates their AWS user interface, I cannot guarantee the included menu screenshots will look the same on your system. However, hopefully they will still provide sufficient information to determine the appropriate settings and options ⚙️ Reach out if you feel I need to update this guide.</p>
<section id="iam-setup" class="level2">
<h2 class="anchored" data-anchor-id="iam-setup">IAM Setup 👤</h2>
<p>Firstly, you need to create a new <a href="https://aws.amazon.com/iam/getting-started/?nc=sn&amp;loc=3">IAM</a> user with more appropriate permissions tailored to the requirements listed in <a href="https://www.nextflow.io/docs/latest/awscloud.html">Nextflow documentation</a>. It is strongly recommended that do not use your root account to run Nextflow pipelines ⚠️</p>
<ol type="1">
<li><p>Open the IAM management console on AWS and under <strong>Users</strong> click <strong>Create User</strong>.</p></li>
<li><p>Enter a name (e.g., “Nextflow-demo”) and leave “Provide access to AWS Management Console” unchecked, then click <strong>Next</strong>.</p>
<p><img src="images/new-user-name.png" class="img-fluid"></p></li>
<li><p>No need to add the user to a group (we will do that soon), click <strong>Next</strong> again, and then finally click <strong>Create user</strong>.</p></li>
<li><p>Now under the <strong>Users</strong> menu, click on your newly created user and then click the <strong>Security credentials</strong> menu/tab.</p></li>
<li><p>Scroll down and click <strong>Create access key</strong> under the <strong>Access keys</strong> section.</p></li>
<li><p>Select <strong>Command Line Interface (CLI)</strong> as the Use case and click <strong>Next</strong> and <strong>Create access key</strong>.</p>
<p><img src="images/cli-access-key.png" class="img-fluid"></p></li>
<li><p>You should be greeted with a new page that includes a Access Key ID 🔑 and SCA (📝 <em>take note of these keys as you will need them towards the end of this guide</em>).</p></li>
<li><p>Next you need to create a user group for the new user to sit within. <em>Generally, on AWS you will apply permissions to a user group rather than a specific user. Additionally, this allows you to set up multiple separate people within the ‘Nextflow group’.</em></p></li>
<li><p>Back under the IAM console select <strong>User groups</strong> and then <strong>Create group</strong>.</p></li>
<li><p>Enter an appropriate name and under <strong>Add users to the group</strong> menu tick your recently created Nextflow user. Click <strong>Create group</strong>.</p>
<p><img src="images/create-user-group-fusion.png" class="img-fluid"></p></li>
<li><p>Now click/open you newly created group and under the <strong>Permissions</strong> menu/tab click the drop down <strong>Add permissions</strong> button and select click <strong>create inline policy</strong>.</p>
<p><img src="images/create-inline-policy.png" class="img-fluid"></p></li>
<li><p>This is where you need to add the IAM policies listed in the <a href="https://www.nextflow.io/docs/latest/aws.html#aws-iam-policies">Nextflow documentation</a>. For all the Batch policies (batch:###) select Batch in the service menu and then find the permission policies under the actions allowed menus. For example “batch:CancelJob”</p>
<p><img src="images/add-canceljob-policy.png" class="img-fluid"></p></li>
<li><p>“ec2:###” policies are under service <strong>EC2</strong>, “ecs:###” policies are under <strong>Elastic Container Service</strong>, “ecr:###” policies are under <strong>Elastic Container Registry</strong>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The policies listed in the <a href="https://www.nextflow.io/docs/latest/aws.html#aws-iam-policies">Nextflow documentation</a> are a bit muddled and not in order, so look closely 👀 for those ecs policies in amongst the ec2 policies.</p>
</div>
</div></li>
<li><p>Work you way through adding all the individual policies (alternatively you can add them via the JSON editor instead of the visual editor).</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <a href="https://www.nextflow.io/docs/latest/aws.html#aws-iam-policies">Nextflow documentation</a> misses one policy that is required for wave/fusion, <code>batch:TagResource</code>. So make sure you also add that one or else you will get an access is not authorized error 🛑 when you try to use fusion later on.</p>
</div>
</div></li>
<li><p>Then finally you will need to add an S3 policy to grant all access, so that Nextlflow can pull input data and publish results, tick the <strong>All S3 actions (s3:*)</strong> checkbox, and select <strong>All</strong> under Resources.</p></li>
</ol>
<p>To be able to use <a href="https://aws.amazon.com/ec2/spot/">spot instances</a> (which I highly recommended you consider 👍) you will need to create an additional role.</p>
<ol type="1">
<li><p>Click <strong>Roles</strong> under the IAM access management menu and click <strong>Create role</strong>.</p>
<p><img src="images/create-new-role.png" class="img-fluid"></p></li>
<li><p>Under Trusted entity type select <strong>AWS service</strong>. Then under Use case select <strong>EC2</strong> as the service or use case, and then select <strong>EC2 - Spot Fleet Tagging</strong>, and finally click <strong>Next</strong>.</p>
<p><img src="images/select-spot-fleet-tagging-role.png" class="img-fluid"></p></li>
<li><p>Click <strong>Next</strong> again and then add an appropriate name e.g.&nbsp;<em>AmazonEC2SpotFleetRole</em> and click <strong>Create role</strong>.</p></li>
</ol>
</section>
<section id="custom-nextflow-ami" class="level2">
<h2 class="anchored" data-anchor-id="custom-nextflow-ami">Custom Nextflow AMI 📦</h2>
<p>AWS batch uses Amazon Machine Images (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a>) to initiate EC2 compute instances that will subsequently run your Nextflow processes. Nextflow tasks submitted to AWS Batch will run under the Amazon Elastic Container Service (<a href="https://aws.amazon.com/ecs/">ECS</a>). ECS (<em>not to be confused with EC2</em>) uses a base Amazon ECS-optimised AMI (with docker pre-installed).</p>
<p>Unlike previous blog posts you no long need to generate AMIs with large <a href="https://aws.amazon.com/ebs/">EBS</a> storage to hold input data or setup EBS autoscaling as we are going to utilise the new fusion functionality to harness the cheaper S3 object storage as our local compute storage for each process. I would recommend leaving the AMI image with the default base 30GiB EBS so there is sufficient space to hold your containers.</p>
<p>You will also need to install the AWS CLI in the base ECS AMI to allow data movement to and from S3 buckets. To set all this up follow these steps:</p>
<ol type="1">
<li><p>Navigate to the EC2 console menu.</p></li>
<li><p>Click <strong>Instances</strong> and then <strong>Launch Instances</strong>.</p></li>
<li><p>Under Quick start click <strong>Browse more AMIs</strong>.</p>
<p><img src="images/launch-an-instance.png" class="img-fluid"></p></li>
<li><p>Click <strong>AWS Marketplace AMIs</strong> and search for <strong>ECS</strong></p></li>
<li><p>At the time of writing <strong>Amazon Linux AMI 2.0.20241023 x86_64 ECS HVM GP2</strong> was the most up-to date. <strong>Select</strong> it and click <strong>Subscribe now</strong> (don’t worry the AMI is free, the pricing is the cost of the EC2 instance you choose to launch).</p>
<p><img src="images/ecs-ami-select.png" class="img-fluid"></p></li>
<li><p>Now in my original post I suggested selecting t2.micro as the instance type, however since then I have had issues during the subsequent conda setup running out of memory so I would now recommend you select something cheap with 4GiB of RAM, such as t3.medium.</p>
<p><img src="images/t3.medium.png" class="img-fluid"></p></li>
<li><p>Select and relevant key pair and network settings based on your setup (I would recommend at a minimum a private VPC and IP-restricted connections via a bastion/jump instance).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The key pair should be for your normal IAM user account, not the Nextflow IAM you created earlier, as you will need to SSH into this instance and run some commands to complete the setup.</p>
</div>
</div></li>
<li><p>Ensure you have the default 30GiB EBS storage 💾 listed under ‘Configure storage’. Also change the storage type from gp2 to <strong>gp3</strong> (for a performance boost at no additional cost - see <a href="https://youtu.be/E5XGxQvqZLs?list=PLPZ8WHdZGxmUdAJlHowo7zL2pN3x97d32&amp;t=459">Matt Vaughn’s NextflowSummit 2022 talk</a> 📽️).</p></li>
<li><p>Click <strong>Launch instance</strong> 🚀</p></li>
<li><p>SSH 💻 into your new instance where you will need to install AWS CLI.</p></li>
<li><p>Once connected run the following commands to install AWS CLI using miniconda (as per the Nextflow documentation).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$HOME</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install <span class="at">-y</span> bzip2 wget</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> Miniconda3-latest-Linux-x86_64.sh <span class="at">-b</span> <span class="at">-f</span> <span class="at">-p</span> <span class="va">$HOME</span>/miniconda</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">$HOME</span><span class="ex">/miniconda/bin/conda</span> install <span class="at">-c</span> conda-forge <span class="at">-y</span> awscli</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> Miniconda3-latest-Linux-x86_64.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>To verify the install was successful</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./miniconda/bin/aws <span class="at">--version</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws-cli/1.19.79</span> Python/3.8.5 Linux/4.14.231-173.361.amzn2.x86_64 botocore/1.20.79</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Under the <strong>Instances</strong> menu in the EC2 console select your relevant instance and click <strong>Actions,</strong> then <strong>Images and Templates</strong>, then <strong>Create Image</strong>.</p></li>
<li><p>Give your new image a name e.g.&nbsp;<em>nextflow-30GiB-ecs-ami</em> and click <strong>Create image</strong>.</p></li>
<li><p>📝Take note of the AMI ID (not the name) that you just generated as you will need this later.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Contrary to what is commonly written in other documentation you no longer need to expand your docker 🐋storage volume to match your allocated EBS storage size. The docker storage automatically expands on the Amazon 2 AMIs which are now default (unlike previous Amazon 1 AMIs).</p>
</div>
</div>
</section>
<section id="batch-environment" class="level2">
<h2 class="anchored" data-anchor-id="batch-environment">Batch Environment 🎛️</h2>
<p>Now it is time to create your Batch environment which entails at least one compute environment and one job queue that Nextflow will submit processes to.</p>
<p>Navigate to the <strong>Batch</strong> AWS console and click on <strong>Compute environments</strong>.</p>
<ol type="1">
<li><p>Click <strong>Create</strong> and select <strong>Amazon Elastic Compute Cloud (Amazon EC2)</strong> as the compute environment.</p></li>
<li><p>Select <strong>Managed</strong> as the orchestration type and enter a suitable name for your new compute environment.</p></li>
<li><p>If this is your first time setting up a Batch environment AWS will create the relevant service role and instance role. Just ensure <strong>Create new role</strong> is selected. Alternatively, under ‘<em>Service role</em>’ select <strong>AWSServiceRoleForBatch</strong> and under ‘<em>Instance Role</em>’ select <strong>ecsInstanceRole</strong>. Click <strong>Next</strong>.</p></li>
<li><p>Leave Minimum and Desired vCPUs as 0. Maximum vCPUs controls the allowed maximum number of parallel vCPU tasks that can run in your compute environment at any one time. Increase or decrease this to an appropriate number based on your requirements.</p></li>
<li><p>‘Allowed instance type’ allows you to control the type of instances that AWS is allowed to try and run your jobs on. Your CPU and memory requirements defined in your Nextflow config will apply a second tier of filtering (i.e.&nbsp;if your memory request is higher than an allowed instance type, obviously that instance type won’t be used). You can leave this as <strong>optimal</strong> and AWS will attempt to find the best instance type match to your CPU and memory request.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>AWS will generally group multiple jobs onto the one large instance, however, this can result in errors, particularly from ‘noisy neighbors’, and I/O and/or network intensive tasks.</p>
<p>If you want to prevent AWS from grouping multiple jobs onto the one larger instance, then you need to specifically define smaller instances types, e.g.&nbsp;r6i.xlarge, r6i.2xlarge, to prevent AWS using super instances such as r6i.24xlarge r6i.32xlarge.</p>
<p>I have also found that when using SPOT instances AWS is less likely to group lots of jobs onto the super sizes instances. Another reason to use SPOT 😉</p>
</div>
</div></li>
<li><p>To use spot instances toggle the <strong>Use EC2 Spot instances</strong> button at the top and define your maximum cut-off for on-demand price under ‘Maximum % on-demand price’. Under ‘spot fleet role’ you will also need to select the <strong>AmazonEC2SpotFleetRole</strong> role that you created earlier.</p>
<p><img src="images/enable-spot.png" class="img-fluid"></p></li>
<li><p>Under ‘Additional configuration’ you can define the allocation strategy.</p>
<p><code>BEST_FIT</code> (default) AWS Batch selects an instance type that best fits the needs of the jobs with a preference for the lowest-cost instance type. If additional instances of the selected instance type aren’t available, AWS Batch waits for the additional instances to be available. If there aren’t enough instances available, or if the user is reaching the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">Amazon EC2 service quotas</a>, then additional jobs don’t run until currently running jobs are complete. This allocation strategy keeps costs lower but can limit scaling. If you’re using Spot Fleets with <code>BEST_FIT</code>, the Spot Fleet IAM Role must be specified. <code>BEST_FIT</code> isn’t supported when updating compute environments. For more information, see <a href="https://docs.aws.amazon.com/batch/latest/userguide/updating-compute-environments.html">Updating compute environments</a>.</p>
<p><code>BEST_FIT_PROGRESSIVE</code> AWS Batch selects additional instance types that are large enough to meet the requirements of the jobs in the queue. Instance types with a lower cost for each unit vCPU are preferred. If additional instances of the previously selected instance types aren’t available, AWS Batch selects new instance types.</p>
<p><code>SPOT_CAPACITY_OPTIMIZED</code> AWS Batch selects one or more instance types that are large enough to meet the requirements of the jobs in the queue. Instance types that are less likely to be interrupted are preferred. This allocation strategy is only available for Spot Instance compute resources.</p></li>
<li><p>Under ‘EC2 configuration’ click <strong>Add EC2 configuration</strong> and select <strong>Amazon Linux 2</strong> as the image type and paste the AMI ID that you created earlier in the <strong>Image ID override</strong> field.</p>
<p><img src="images/add-ec2-config.png" class="img-fluid"></p>
<p><img src="images/enter-ami-here.png" class="img-fluid"></p></li>
<li><p>Click <strong>Next</strong> and enter the appropriate network configuration for your VPC.</p></li>
<li><p>Click <strong>Next,</strong> check your settings and then click <strong>Create compute environment</strong>.</p></li>
</ol>
<p>Still within the <strong>Batch</strong> AWS console and click on <strong>Job queues</strong>.</p>
<ol type="1">
<li>Click <strong>Create</strong> and select ‘Amazon Elastic Compute Cloud (Amazon EC2)’ as the compute environment.</li>
<li>Enter a suitable name for your new job queue (📝 <em>take note of this name you will need it later</em>)</li>
<li>Under ‘Connected compute environments’ select the compute environment that you just created</li>
<li>Click <strong>Create job queue</strong>.</li>
</ol>
<p>You will want Nextflow to use an S3 bucket to store all the working files and results rather than a local connection.</p>
<ol type="1">
<li>Navigate to the S3 service under the AWS management console and create a new private bucket in your relevant region.</li>
<li>Create a new folder within the bucket to serve as the Nextflow working directory (📝 take note of the S3 URI address as you will need this next)</li>
</ol>
</section>
<section id="nextflow-config-launchpad" class="level2">
<h2 class="anchored" data-anchor-id="nextflow-config-launchpad">Nextflow Config &amp; Launchpad 🚀</h2>
<p>Now all you now need to do is set up your Nextflow config with the relevant details of your AWS setup. An example of an initial config file is:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>nextflow.config</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="nextflow.config"><pre class="sourceCode groovy code-with-copy"><code class="sourceCode groovy"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Select the awsbatch executor</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>process<span class="op">.</span>executor <span class="op">=</span> <span class="st">'awsbatch'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">//Name of the AWS Batch job queue that you just created</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>process<span class="op">.</span>queue <span class="op">=</span> <span class="st">'my-batch-queue'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">//region where we want to run this in</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>aws<span class="op">.</span>region <span class="op">=</span> <span class="st">'ap-southeast-2'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">//Path to the aws cli tool you installed in your AMI</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>aws<span class="op">.</span>batch<span class="op">.</span>cliPath <span class="op">=</span> <span class="st">'/home/ec2-user/miniconda/bin/aws'</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">//S3 working directory that you just created</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">'s3://bucket_you_created/work/'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will need to include this config with all the Nextflow pipelines you intend to run on your new AWS setup.</p>
<p>The next step is to create, what I like you call your <strong>nf-launchpad</strong> - i.e.&nbsp;a EC2 instance that you submit/run your Nextflow pipelines from and that essentially runs all the communication with AWS Batch. You could do this locally, but this doesn’t provide you any protection against power or internet disconnects.</p>
<p>Navigate to the <strong>Instances</strong> within the <strong>EC2</strong> console and click <strong>Launch instances</strong>.</p>
<ol type="1">
<li><p>Add an appropriate name, e.g.&nbsp;nf-launchpad</p></li>
<li><p>Select a linux 🐧 based AMI, I typically just go for <strong>Ubuntu</strong> under the <strong>Quick Start</strong> tab.</p></li>
<li><p>Under instance type choose a small to medium instance type. Generally you don’t need too much grunt here as Batch runs all the processes. Initially I started using a t2.micro instance, which worked flawlessly for a good innings, however as I started to scale up the intensity of my pipelines and the number of parallel process and data movement, it started to get too much for the little mighty <a href="https://aws.amazon.com/ec2/instance-types/t2/">t2.micro</a>. So now I run something like a <a href="https://aws.amazon.com/ec2/instance-types/r6a/">r6a.large</a>.</p></li>
<li><p>Select and relevant key pair and network settings based on your setup (I would recommend at a minimum a private VPC and IP-restricted connections via a bastion/jump instance).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The key pair should be for your normal IAM user account, not the nextflow IAM you created earlier, as you will need to SSH into this instance and to run your Nextflow pipelines.</li>
</ol>
</div>
</div></li>
<li><p>Ensure you have the default 30GiB EBS storage 💾 listed under ‘Configure storage’. Also change the storage type from gp2 to <strong>gp3</strong> (for a performance boost at no additional cost - see <a href="https://youtu.be/E5XGxQvqZLs?list=PLPZ8WHdZGxmUdAJlHowo7zL2pN3x97d32&amp;t=459">Matt Vaughn’s NextflowSummit 2022 talk</a> 📽️).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>S3 is used as the working directory, so you don’t need too much storage space attached to your nf-launchpad.</p>
</div>
</div></li>
<li><p>Click <strong>Launch instance</strong> 🚀</p></li>
<li><p>SSH 💻 into your new instance where you will need to install AWS CLI</p></li>
<li><p>You can install the AWS CLI using the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS documented method</a> rather then the miniconda method we used earlier.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="st">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="at">-o</span> <span class="st">"awscliv2.zip"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> awscliv2.zip</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ./aws/install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>The last step is setting up your security credentials 🔐 to allow Nextflow to securely communicate and submit jobs to AWS batch. After you have installed the AWS CLI <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html">run</a> <code>aws configure</code> and enter the relevant Key ID, Access Key, and Region when prompted. These are the keys that AWS provided when you generated your Nextflow programmatic user at the start of this guide.</p></li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>DO NOT</strong> store your credentials in your Nextflow configuration file as some tutorials suggest.</p>
</div>
</div>
</section>
<section id="additional-notes" class="level2">
<h2 class="anchored" data-anchor-id="additional-notes">Additional Notes 🗒️</h2>
<ul>
<li><p>AWS batch jobs can take a few minutes to spin up, be patient before assuming you have set something up wrong.</p></li>
<li><p>If you are using spot instances and your maximum % on-demand price is set too low your jobs make take a long time to start or may not run at all.</p></li>
<li><p>You can view the log stream of your jobs by clicking through the ‘Running’ job numbers in the Batch dashboard and clicking the <strong>Log stream name -</strong> helpful to determine where a job is up to in a script</p></li>
<li><p>The <a href="https://www.nextflow.io/slack-invite.html">Nextflow slack channel</a> is a great place to raise any questions if you are still experiencing issues after following this setup guide, or want to experiment with some more advanced configurations and setups.</p></li>
</ul>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
</section>
<section id="fusion-storage" class="level2">
<h2 class="anchored" data-anchor-id="fusion-storage">Fusion storage 💾</h2>
<p>You finally made it 🥳 to the actual bit your probably opened this blog post for - how do I tell Nextflow to use the fusion file storage system so I no longer need to rely on EBS auto-scaling? Well its actually ridiculously simply add <code>fusion.enabled = true</code> and <code>wave.enabled = true</code> to you Nextflow config, for example 👇</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>nextflow.config</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="nextflow.config"><pre class="sourceCode groovy code-with-copy"><code class="sourceCode groovy"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Select the awsbatch executor</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>process<span class="op">.</span>executor <span class="op">=</span> <span class="st">'awsbatch'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">//Name of the AWS Batch job queue that you just created</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>process<span class="op">.</span>queue <span class="op">=</span> <span class="st">'my-batch-queue'</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">//region where we want to run this in</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>aws<span class="op">.</span>region <span class="op">=</span> <span class="st">'ap-southeast-2'</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">//Path to the aws cli tool you installed in your AMI</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>aws<span class="op">.</span>batch<span class="op">.</span>cliPath <span class="op">=</span> <span class="st">'/home/ec2-user/miniconda/bin/aws'</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">//S3 working directory that you just created</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">'s3://bucket_you_created/work/'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">//spot instance retries</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>aws<span class="op">.</span>batch<span class="op">.</span>maxSpotAttempts <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">//fusion and wave configuration</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>fusion<span class="op">.</span>enabled <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>wave<span class="op">.</span>enabled <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">//per process configurations</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>process <span class="op">{</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    withName<span class="op">:</span> <span class="st">'GEN_FILE'</span> <span class="op">{</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        container <span class="op">=</span> <span class="st">'public.ecr.aws/ubuntu/ubuntu:24.04_stable'</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        cpus <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        memory <span class="op">=</span> <span class="fl">4.</span>GB</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is no requirement to use <a href="https://seqera.io/containers/">Seqera containers</a>, you can continue to use <a href="https://gallery.ecr.aws/biocontainers/">biocontainers hosted on AWS ECR</a>, Wave just steps in to provision them with the Fusion layer attached. However, I would recommend checking out the free Seqera container service, the ability to seamlessly create multitooled containers and also ARM based containers is brilliant! Not to mention the interface is a lot better (IMO) 🤩 than any other container repository out there.</p>
<p>Ok, lets test everything is working, take this demo pipeline that I have made below and run it firstly <strong>without</strong> fusion and wave enabled (i.e.&nbsp;<code>fusion.enabled = false</code> &amp; <code>wave.enabled = false</code>), it should eventually fail.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>main.nf</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="main.nf"><pre class="sourceCode groovy code-with-copy"><code class="sourceCode groovy"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>#<span class="op">!</span><span class="st">/usr/</span>bin<span class="op">/</span>env nextflow</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a list of file sizes in GiB (e.g., 1GiB, 20GiB, 50GiB)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>params<span class="op">.</span>file_sizes <span class="op">=</span> <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">50</span><span class="op">]</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Process to create files of specified sizes</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>process GEN_FILE <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    val size </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file</span><span class="op">(</span><span class="st">"file_</span><span class="ss">${</span>size<span class="ss">}</span><span class="st">G.dat"</span><span class="op">)</span> </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="st">    dd if=/dev/zero of=file_</span><span class="ss">${</span>size<span class="ss">}</span><span class="st">G.dat bs=1G count=</span><span class="ss">${</span>size<span class="ss">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Channel for file sizes</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">from</span><span class="op">(</span>params<span class="op">.</span>file_sizes<span class="op">)</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span> <span class="op">{</span> file_size_ch <span class="op">}</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GEN_FILE</span><span class="op">(</span>file_size_ch<span class="op">)</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    GEN_FILE<span class="op">.</span>out<span class="op">.</span><span class="fu">view</span> <span class="op">{</span> file <span class="op">-&gt;</span> <span class="st">"File: </span><span class="ss">${</span>file<span class="ss">}</span><span class="st">"</span> <span class="op">}</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example of failed run 👇</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/failed.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Now <strong>enable</strong> Fusion and Wave in your config and run it again, and it should work, if everything has been setup correctly.</p>
<p>Example of successful run (notice the fusion enabled label against the executor) 👇</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/worked.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>So what is happening in the pipeline 👆 you ask? Well it has just one process that runs 3 times in parallel, and within the process it will try to generate a file that is either, 1GiB, 20GiB or 50GiB in size. As the Nextflow AMI you generated only has 30GiB of storage attached the 50GiB file generation process should fail unless fusion is enabled in which case it can then use S3 as the local storage.</p>
<p>Just a nice simple example to test everything is working before you dive into your bigger pipelines.</p>
<p>Hopefully everything worked, if so time to party!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/baby-yoda.gif" class="img-fluid quarto-figure quarto-figure-center figure-img" width="320"></p>
</figure>
</div>
<p>If not, don’t give up, read back over this guide and see if there was something you missed or find me on the Nextflow Slack channel for help.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="lpembleton/lpembleton.blog" data-repo-id="R_kgDOIfz78A" data-category="Announcements" data-category-id="DIC_kwDOIfz78M4CZhkM" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2024 Luke Pembleton ∙ Made with <a href="https://quarto.org">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
<p><a class="link-dark me-1" href="https://genomic.social/@lwpembleton" title="mastodon" target="_blank" rel="noopener"><i class="fa-brands fa-mastodon" aria-label="mastodon"></i></a> <a class="link-dark me-1" href="https://github.com/lpembleton" title="github" target="_blank" rel="noopener"><i class="fa-brands fa-github" aria-label="github"></i></a> <a class="link-dark me-1" href="https://twitter.com/lwpembleton" title="twitter" target="_blank" rel="noopener"><i class="fa-brands fa-twitter" aria-label="twitter"></i></a> <a class="link-dark me-1" href="https://scholar.google.com/citations?user=r7RmM00AAAAJ&amp;hl=en" title="Google Scholar" target="_blank" rel="noopener"><i class="ai  ai-google-scholar" title="" style="color:"></i></a> <a class="link-dark me-1" href="https://linkedin.com/in/lpembleton" title="LinkedIn" target="_blank" rel="noopener"><i class="fa-brands fa-linkedin" aria-label="linkedin"></i></a></p>
<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences 🍪</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>