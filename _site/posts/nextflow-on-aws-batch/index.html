<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="LW Pembleton">
<meta name="dcterms.date" content="2022-11-25">
<meta name="description" content="An introductory guide to setting up Nextflow with AWS Batch">

<title>Luke Pembleton - Nextflow on AWS Batch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<meta property="og:title" content="Luke Pembleton - Nextflow on AWS Batch">
<meta property="og:description" content="An introductory guide to setting up Nextflow with AWS Batch">
<meta property="og:image" content="https://lpembleton.rbind.io/posts\nextflow-on-aws-batch\images\jenessaa-lu-gTKFunYTVds-unsplash.jpg">
<meta property="og:site-name" content="Luke Pembleton">
<meta name="twitter:title" content="Luke Pembleton - Nextflow on AWS Batch">
<meta name="twitter:description" content="An introductory guide to setting up Nextflow with AWS Batch">
<meta name="twitter:image" content="https://lpembleton.rbind.io/posts\nextflow-on-aws-batch\images\jenessaa-lu-gTKFunYTVds-unsplash.jpg">
<meta name="twitter:site" content="@lwpembleton">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Luke Pembleton</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications/publications.html">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lpembleton"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/lwpembleton"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=r7RmM00AAAAJ&amp;hl=en">
 <span class="menu-text"><i class="ai  ai-google-scholar" title="" style="color:"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://publons.com/researcher/3450394/luke-pembleton/">
 <span class="menu-text"><i class="ai  ai-publons" title="" style="color:"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/lpembleton"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://lpembleton.github.io/StAMPP/">
 <span class="menu-text"><i class="fa-solid fa-box-open" aria-label="box-open"></i></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Nextflow on AWS Batch</h1>
                  <div>
        <div class="description">
          An introductory guide to setting up Nextflow with AWS Batch
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Nextflow</div>
                <div class="quarto-category">AWS</div>
                <div class="quarto-category">Batch</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>LW Pembleton </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 25, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#iam-setup" id="toc-iam-setup" class="nav-link active" data-scroll-target="#iam-setup">IAM Setup</a></li>
  <li><a href="#custom-nextflow-ami" id="toc-custom-nextflow-ami" class="nav-link" data-scroll-target="#custom-nextflow-ami">Custom Nextflow AMI</a></li>
  <li><a href="#batch-environment" id="toc-batch-environment" class="nav-link" data-scroll-target="#batch-environment">Batch Environment</a></li>
  <li><a href="#nextflow-config" id="toc-nextflow-config" class="nav-link" data-scroll-target="#nextflow-config">Nextflow Config</a></li>
  <li><a href="#additional-notes" id="toc-additional-notes" class="nav-link" data-scroll-target="#additional-notes">üóíÔ∏èAdditional Notes:</a></li>
  <li><a href="#common-errors" id="toc-common-errors" class="nav-link" data-scroll-target="#common-errors">Common errors</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/jenessaa-lu-gTKFunYTVds-unsplash.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><sub>Photo&nbsp;by&nbsp;<a href="https://unsplash.com/@jenessaa?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Jenessaa&nbsp;Lu</a>&nbsp;on&nbsp;Unsplash</sub></figcaption><p></p>
</figure>
</div>
<p>The following is a general guide on how to set up Nextflow with AWS batch as the compute environment. I would highly recommend that you use your local environment or at least a smaller test dataset for pipeline development, transferring to AWS batch when in a working production state.</p>
<p>Although Gandalf üßô trims his beard more often than Amazon updates their AWS user interface, I cannot guarantee the included menu screenshots will look the same on your system. However, hopefully they will still provide sufficient information to determine the appropriate settings and options. Reach out if you feel I need to update this guide.</p>
<section id="iam-setup" class="level2">
<h2 class="anchored" data-anchor-id="iam-setup">IAM Setup</h2>
<p>Firstly you need to create a new <a href="https://aws.amazon.com/iam/getting-started/?nc=sn&amp;loc=3">IAM</a> with more appropriate permissions tailored to the requirements listed in <a href="https://www.nextflow.io/docs/latest/awscloud.html">Nextflow documentation</a>. It is strongly recommended that do not use your root account to run Nextflow pipelines.</p>
<ol type="1">
<li><p>Open the IAM management console on AWS and add a new user</p></li>
<li><p>Enter an appropriate user name for example ‚ÄòNextflow-access‚Äô. Under access type, select <em>programmatic access</em></p>
<p><img src="images/aws-iam-add-user.png" class="img-fluid"></p></li>
<li><p>Next you need to create a user group for the new user to sit within. Generally, on AWS you will apply permissions to a user group rather than a specific user. Additionally, this allows you to set up multiple separate people within the ‚ÄòNextflow group‚Äô. Again, enter an appropriate name and click <strong>Create group</strong></p></li>
<li><p>Add any metadata tags if appropriate</p></li>
<li><p>Click <strong>Create user</strong>. You should be greeted with a new page that includes a Access Key ID and SCA (üìù <em>take note of these keys as you will need them towards the end of this guide</em>)</p></li>
</ol>
<p>Now that you have your new user and Nextflow group you will need to apply the required permissions.</p>
<ol type="1">
<li><p>From the IAM user panel click <strong>User groups</strong> select your recently created ‚Äònextflow‚Äô group, and under the <strong>permissions</strong> menu click on the <strong>Attach policy</strong> button</p>
<p><img src="images/attach-policies.png" class="img-fluid"></p></li>
<li><p>Click <strong>Create policy</strong></p>
<p><img src="images/create-policy.png" class="img-fluid"></p></li>
<li><p>Use the visual editor to add all the required permissions</p>
<p><img src="images/create-policy-permissions.png" class="img-fluid"></p>
<p><a href="https://www.nextflow.io/docs/latest/awscloud.html">Minimal permissions policies</a> to be attached to the AWS account used by Nextflow are:</p>
<ul>
<li><p>To interface AWS Batch:</p>
<pre><code>"batch:DescribeJobQueues"
"batch:CancelJob"
"batch:SubmitJob"
"batch:ListJobs"
"batch:DescribeComputeEnvironments"
"batch:TerminateJob"
"batch:DescribeJobs"
"batch:RegisterJobDefinition"
"batch:DescribeJobDefinitions"</code></pre></li>
<li><p>To be able to see the <a href="https://aws.amazon.com/ec2/">EC2</a> instances:</p>
<pre><code>"ecs:DescribeTasks"
"ec2:DescribeInstances"
"ec2:DescribeInstanceTypes"
"ec2:DescribeInstanceAttribute"
"ecs:DescribeContainerInstances"
"ec2:DescribeInstanceStatus"</code></pre></li>
<li><p>To pull container images stored in the <a href="https://aws.amazon.com/ecr/">ECR</a> repositories:</p>
<pre><code>"ecr:GetAuthorizationToken"
"ecr:BatchCheckLayerAvailability"
"ecr:GetDownloadUrlForLayer"
"ecr:GetRepositoryPolicy"
"ecr:DescribeRepositories"
"ecr:ListImages"
"ecr:DescribeImages"
"ecr:BatchGetImage"
"ecr:GetLifecyclePolicy"
"ecr:GetLifecyclePolicyPreview"
"ecr:ListTagsForResource"
"ecr:DescribeImageScanFindings"</code></pre></li>
</ul></li>
<li><p>You also need to <a href="https://www.nextflow.io/docs/latest/awscloud.html#s3-policies">add permissions for S3</a> so that nextlflow can pull input data and publish results. Still using the visual editor select <strong>S3</strong> as the service and then select the <strong>All S3 actions (s3:*)</strong> check box under actions. You may get notifications of other ‚Äòdependency‚Äô type permissions that are required, follow the instructions to add these as well.</p>
<p><img src="images/s3-policy.png" class="img-fluid"></p></li>
<li><p>Add any metadata tags if appropriate</p></li>
<li><p>Give your new policy a name and click <strong>Create policy</strong></p></li>
<li><p>Select your newly created permission policy to add to the user group and click <strong>Add permissions.</strong> <em>Hint: you can find your new policy by</em> üîç<em>searching in the filter box</em></p></li>
</ol>
<p>To be able to use <a href="https://aws.amazon.com/ec2/spot/">spot instances</a> you will need to create an additional role.</p>
<ol type="1">
<li><p>Click <strong>Roles</strong> under the IAM access management menu and click <strong>Create role</strong></p>
<p><img src="images/create-role.png" class="img-fluid"></p></li>
<li><p>Select <strong>AWS service</strong> and <strong>EC2</strong> under common use cases, click <strong>Next</strong></p></li>
<li><p>Search for <strong>AmazonEC2SpotFleetTaggingRole</strong> select it and click <strong>Next</strong></p></li>
<li><p>Add a role name, e.g.&nbsp;<em>AmazonEC2SpotFleetRole</em> and click <strong>Create role</strong></p></li>
</ol>
</section>
<section id="custom-nextflow-ami" class="level2">
<h2 class="anchored" data-anchor-id="custom-nextflow-ami">Custom Nextflow AMI</h2>
<p>AWS batch uses Amazon Machine Images (<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a>) to initiate EC2 compute instances that will subsequently run your Nextflow processes. Nextflow tasks submitted to AWS Batch will run under the Amazon Elastic Container Service (<a href="https://aws.amazon.com/ecs/">ECS</a>). ECS (<em>not to be confused with EC2</em>) uses a base Amazon ECS-optimised AMI (with docker pre-installed). Although Nextflow &amp; Batch will control the CPU and memory resource request and allocation you need to ensure you base ECS AMI has sufficient <a href="https://aws.amazon.com/ebs/">EBS</a> storage to hold any relevant input and working data files, such as sequence reads, indexes etc. You will also need to install the AWS CLI in the base ECS AMI to allow data movement to and from S3 buckets. To set all this up follow these steps:</p>
<ol type="1">
<li><p>Navigate to the EC2 console menu</p></li>
<li><p>Click <strong>Instances</strong> and then <strong>Launch Instances</strong></p></li>
<li><p>Under ‚Äòquick start‚Äô click <strong>Browse more AMIs</strong></p></li>
<li><p>Click <strong>AWS Marketplace AMIs</strong> and search for <strong>ECS</strong></p></li>
<li><p>At the time of writing <strong>amzn2-ami-ecs-hvm-2.0.20221025-x86_64-ebs</strong> was the most up-to-date ECS AMI. Select it</p>
<p><img src="images/amsn2-ecs-marketplace.png" class="img-fluid"></p></li>
<li><p>Select the t2.micro instance type</p></li>
<li><p>Select and relevant key pairs and network settings based on your setup (I would recommend at a minimum a private VPC and IP-restricted connections via a bastion instance)</p></li>
<li><p>Ensure you have at least 30GiB storage üíæ listed under ‚ÄòConfigure storage‚Äô. Also change the storage type from gp2 to <strong>gp3</strong> (for a performance boost at no additional cost - see <a href="https://youtu.be/E5XGxQvqZLs?list=PLPZ8WHdZGxmUdAJlHowo7zL2pN3x97d32&amp;t=459">Matt Vaughn‚Äôs NextflowSummit 2022 talk</a> üìΩÔ∏è).</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For some Nextflow processes your will need more than 30GiB of EBS storage. I would recommend making additional AMIs (based on this image) for these specific tasks and assigning them to specific Batch job queues, see later on.</p>
</div>
</div></li>
<li><p>Click <strong>Launch instance</strong> üöÄ</p></li>
<li><p>SSH üíª into your new instance where you will need to install AWS CLI</p></li>
<li><p>Once connected run the following commands to install AWS CLI</p>
<pre><code>cd $HOME
sudo yum install -y bzip2 wget
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $HOME/miniconda
$HOME/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh</code></pre></li>
<li><p>To verify the install was successful</p>
<pre><code>$ ./miniconda/bin/aws --version
aws-cli/1.19.79 Python/3.8.5 Linux/4.14.231-173.361.amzn2.x86_64 botocore/1.20.79</code></pre></li>
<li><p>Under the <strong>Instances</strong> menu in the EC2 console select your relevant instance and click <strong>Actions,</strong> then <strong>Images and Templates</strong>, then <strong>Create Image</strong></p></li>
<li><p>Give your new image a name e.g.&nbsp;<em>nextflow-30GiB-ecs-ami</em> and click <strong>Create image</strong></p></li>
<li><p>üìùTake note of the AMI ID (not the name) that you just generated as you will need this later</p></li>
</ol>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Contrary to what is commonly written in other documentation you no longer need to expand your docker üêãstorage volume to match your allocated EBS storage size. The docker storage automatically expands on the Amazon 2 AMIs which are now default (unlike previous Amazon 1 AMIs).</p>
</div>
</div>
</section>
<section id="batch-environment" class="level2">
<h2 class="anchored" data-anchor-id="batch-environment">Batch Environment</h2>
<p>Now it is time to create your Batch environment which entails at least one compute environment and one job queue that Nextflow will submit processes to.</p>
<p>Navigate to the Batch AWS console and click on <strong>Compute environments</strong>.</p>
<ol type="1">
<li><p>Click <strong>Create</strong> and select <strong>Amazon Elastic Compute Cloud (Amazon EC2)</strong> as the compute environment.</p></li>
<li><p>Select <strong>Managed</strong> as the orchestration type and enter a suitable name for your new compute environment.</p></li>
<li><p>If this is your first time setting up a Batch environment AWS will create the relevant service role and instance role. Just ensure ‚Äò<em>Create new role</em>‚Äô is selected. Alternatively, under ‚Äò<em>Service role</em>‚Äô select <strong>AWSServiceRoleForBatch</strong> and under ‚Äò<em>Instance Role</em>‚Äô select <strong>ecsInstanceRole</strong>. Click <strong>Next Page</strong></p></li>
<li><p>Leave Minimum and Desired vCPUs as 0. Maximum vCPUs controls the allowed maximum number of parallel vCPU tasks that can run in your compute environment at any one time. Increase or decrease this to an appropriate number based on your requirements.</p></li>
<li><p>‚ÄòAllowed instance type‚Äô allows you to control the type of instances that AWS is allowed to try and run your jobs on. Your CPU and memory requirements defined in your Nextflow config will apply a second tier of filtering (i.e.&nbsp;if your memory request is higher than an allowed instance type, obviously that instance type won‚Äôt be used). You can leave this as ‚Äòoptimal‚Äô and AWS will attempt to find the best instance type match to your CPU and memory request.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>AWS will generally group multiple jobs onto the one large instance, however, this can result in errors, particularly from noisy neighbors, and I/O and/or network intensive tasks.</p>
<p>If you want to prevent AWS from grouping multiple jobs onto the one larger instance, then you need to specifically define smaller instances types, e.g.&nbsp;r6i.xlarge, r6i.2xlarge, to prevent AWS using super instances such as r6i.24xlarge r6i.32xlarge.</p>
</div>
</div></li>
<li><p>To use spot instances toggle the <strong>Use EC2 Spot instances</strong> button at the top and define your maximum cut-off for on-demand price under ‚ÄòMaximum % on-demand price‚Äô. Under ‚Äòspot fleet role‚Äô you will also need to select the <strong>AmazonEC2SpotFleetRole</strong> role that you created earlier.</p></li>
<li><p>Under ‚ÄòAdditional configuration‚Äô you can define the allocation strategy</p>
<p><code>BEST_FIT</code> (default) AWS Batch selects an instance type that best fits the needs of the jobs with a preference for the lowest-cost instance type. If additional instances of the selected instance type aren‚Äôt available, AWS Batch waits for the additional instances to be available. If there aren‚Äôt enough instances available, or if the user is reaching the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">Amazon EC2 service quotas</a>, then additional jobs don‚Äôt run until currently running jobs are complete. This allocation strategy keeps costs lower but can limit scaling. If you‚Äôre using Spot Fleets with <code>BEST_FIT</code>, the Spot Fleet IAM Role must be specified. <code>BEST_FIT</code> isn‚Äôt supported when updating compute environments. For more information, see <a href="https://docs.aws.amazon.com/batch/latest/userguide/updating-compute-environments.html">Updating compute environments</a>.</p>
<p><code>BEST_FIT_PROGRESSIVE</code>AWS Batch selects additional instance types that are large enough to meet the requirements of the jobs in the queue. Instance types with a lower cost for each unit vCPU are preferred. If additional instances of the previously selected instance types aren‚Äôt available, AWS Batch selects new instance types.</p>
<p><code>SPOT_CAPACITY_OPTIMIZED</code>AWS Batch selects one or more instance types that are large enough to meet the requirements of the jobs in the queue. Instance types that are less likely to be interrupted are preferred. This allocation strategy is only available for Spot Instance compute resources.</p></li>
<li><p>Under ‚ÄòEC2 configuration‚Äô click <strong>Add EC2 configuration</strong> and select <strong>Amazon Linux 2</strong> as the image type and paste the AMI ID that you created earlier in the ‚ÄòImage ID override‚Äô box.</p>
<p><img src="images/instance-config.png" class="img-fluid"></p></li>
<li><p>Click <strong>Next page</strong> and enter the appropriate network configuration for your VPC</p></li>
<li><p>Click <strong>Next page,</strong> check your settings and then click <strong>Create compute environment</strong></p></li>
</ol>
<p>Still within the Batch AWS console and click on <strong>Job queues</strong>.</p>
<ol type="1">
<li>Click <strong>Create</strong> and select ‚ÄòAmazon Elastic Compute Cloud (Amazon EC2)‚Äô as the compute environment.</li>
<li>Enter a suitable name for your new job queue (üìù <em>take note of this name you will need it later</em>)</li>
<li>Under ‚ÄòConnected compute environments‚Äô select the compute environment that you just created</li>
<li>Click <strong>Create job queue</strong></li>
</ol>
<p>You will want Nextflow to use an S3 bucket to store all the working files and results rather than a local connection.</p>
<ol type="1">
<li>Navigate to the S3 service under the AWS management console and create a new private bucket in your relevant region.</li>
<li>Create a new folder within the bucket to serve as the Nextflow working directory (üìù take note of the S3 URI address as you will need this next)</li>
</ol>
</section>
<section id="nextflow-config" class="level2">
<h2 class="anchored" data-anchor-id="nextflow-config">Nextflow Config</h2>
<p>Now all you now need to do is set up your Nextflow config with the relevant details of your AWS setup. An example of initial config file is:</p>
<pre><code>//Select the awsbatch executor
process.executor = 'awsbatch'

//Name of the AWS Batch job queue that you just created
process.queue = 'my-batch-queue'

//region where we want to run this in
aws.region = 'ap-southeast-2'

//Path to the aws cli tool you installed in your AMI
aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'

//S3 working directory that you just created
workDir = 's3://bucket_you_created/work/'</code></pre>
<p>The last step is setting up your security credentials üîê to allow Nextflow to securely communicate and submit jobs to AWS batch. The best approach is to <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">install AWS CLI</a> locally (or in a EC2 instance if <a href="https://www.nextflow.io/docs/latest/awscloud.html#pipeline-execution">submitting from EC2</a>).</p>
<p>Then <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html">run</a> <code>AWS configure</code> and enter the relevant Key ID, Access Key, and Region when prompted. These are the keys that AWS provided when you generated your Nextflow programmatic user at the start of this guide.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>DO NOT</strong> store your credentials in your Nextflow configuration file as some tutorials suggest.</p>
</div>
</div>
</section>
<section id="additional-notes" class="level2">
<h2 class="anchored" data-anchor-id="additional-notes">üóíÔ∏èAdditional Notes:</h2>
<ul>
<li><p>AWS batch jobs can take a few minutes to spin up, be patient before assuming you have set something up wrong</p></li>
<li><p>If you are using spot instances and your maximum % on-demand price is set too low your jobs make take a long time to start or may not run at all</p></li>
<li><p>You can view the log stream of your jobs by clicking through the ‚ÄòRunning‚Äô job numbers in the Batch dashboard and clicking the <strong>Log stream name -</strong> helpful to determine where a job is up to in a script</p></li>
<li><p>The <a href="https://www.nextflow.io/slack-invite.html">Nextflow slack channel</a> is a great place to raise any questions if you are still experiencing issues after following this setup guide, or want to experiment with some more advanced configurations and setups.</p></li>
</ul>
</section>
<section id="common-errors" class="level2">
<h2 class="anchored" data-anchor-id="common-errors">Common errors</h2>
<p>Below are a list of common errors. Although the proposed solution has been demonstrated to work it may not always work in your specific scenario.</p>
<p><code>Task failed to start - CannotPullContainerError: context canceled</code></p>
<p>Proposed solution: Increase your AMI EBS storage.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>